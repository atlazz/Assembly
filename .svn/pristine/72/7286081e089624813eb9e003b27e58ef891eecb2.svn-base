{"version":3,"sources":["..\\..\\..\\..\\..\\assets\\scripts\\component/assets\\scripts\\component\\Loading.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"..\\..\\..\\..\\..\\assets\\scripts\\component","sourcesContent":["import Global from \"../Global\";\r\nimport * as Const from \"../Const\";\r\nimport wx from '../SDK/wx';\r\nimport ws from '../SDK/ws';\r\n\r\nclass Loading {\r\n\r\n    public isGameDataLoaded: boolean = false;\r\n\r\n    private onGameDataLoaded: Function;\r\n\r\n    /**微信环境初始化*/\r\n    public initWeixin(onGameDataLoaded?: Function) {\r\n        this.onGameDataLoaded = onGameDataLoaded;\r\n\r\n        wx.showShareMenu({\r\n            withShareTicket: true\r\n        });\r\n        wx.onShareAppMessage(() => {\r\n            let option = ws.createShareOptions({ pos: 'ShareAppButton' });\r\n            return {\r\n                title: option.title,\r\n                imageUrl: option.imageUrl,\r\n                query: option.query,\r\n            }\r\n        });\r\n        ws.init({\r\n            host: 'ws.lesscool.cn', // 暂时用这个域名，后面会支持api.websdk.cn这个域名\r\n            version: Const.VERSION, // 当前的小游戏版本号，只能以数字\r\n            appid: 1141, // 此项目在云平台的appid\r\n            secret: '8a4b117c17f8134b3bdc5567571339d6', // 此项目在云平台的secret, 用于与后端通信签名\r\n            share: {\r\n                title: '全民欢乐，天天游戏！', // 默认分享文案\r\n                image: 'http://oss.lesscool.cn/fcdh/96d172496dbafa4ab9c8335a7133476c.png', // 默认分享图片\r\n            },\r\n        })\r\n        this.loginWs();\r\n    }\r\n\r\n    /**登录ws后台*/\r\n    private loginWs() {\r\n        wx.showLoading({ title: '登录中', mask: true });\r\n        ws.onLoginComplete(this.onLoginComplete.bind(this));\r\n        ws.login();\r\n    }\r\n\r\n    /**登录ws后台完成*/\r\n    private onLoginComplete(res, gameData) {\r\n        if (ws.getLoginStatus() === 'success') {\r\n            console.log(\"login_succeed\")\r\n            ws.traceEvent('login_succeed');\r\n            wx.hideLoading();\r\n            console.log('ws.conf', ws.conf); // 通用配置\r\n            console.log('ws.user', ws.user); // 用户信息\r\n            console.log('ws.data', ws.data); // 本地保存的游戏数据\r\n            this.loadConfig();\r\n            this.loadGameData(gameData);\r\n        } else if (ws.getLoginStatus() === 'fail') {\r\n            console.log(\"login_failed\")\r\n            ws.traceEvent('login_failed');\r\n            wx.hideLoading();\r\n            wx.showModal({\r\n                title: '登陆失败',\r\n                content: '请允许授权',\r\n                confirmText: '重新登陆',\r\n                cancelText: '关闭',\r\n                success(res) {\r\n                    wx.showLoading({ title: '登录中', mask: true });\r\n                    ws.login();\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    /**后台配置加载完成*/\r\n    private loadConfig() {\r\n        (<any>Object).assign(Global.config, ws.conf);\r\n    }\r\n\r\n    /**加载后台游戏数据*/\r\n    private loadGameData(gameData) {\r\n        if (gameData && gameData.updateTimestamp) {\r\n            if (ws.data && ws.data.updateTimestamp && ws.data.updateTimestamp > gameData.updateTimestamp) {\r\n                ws.setAllData(ws.data, true);\r\n            } else {\r\n                ws.setAllData(gameData);\r\n            }\r\n        } else if (!ws.data || !ws.data.updateTimestamp) {\r\n            ws.setAllData(Global.gameData, true);\r\n        }\r\n        Global.gameData = (<any>Object).assign(Global.gameData, ws.data);\r\n        //关闭更新游戏数据\r\n        wx.onHide(() => {\r\n            this.updateGameData(true);\r\n        });\r\n        //刷新当前广告banner\r\n        ws.onShow((res) => {\r\n\r\n        });\r\n\r\n        this.isGameDataLoaded = true;\r\n\r\n        this.onGameDataLoaded && this.onGameDataLoaded();\r\n    }\r\n\r\n    /**提交游戏数据*/\r\n    updateGameData(post: boolean) {\r\n        Global.gameData.updateTimestamp = Date.now();\r\n        post && console.log('updateGameData', Global.gameData);\r\n        CC_WECHATGAME && ws.setAllData(Global.gameData, post);\r\n    }\r\n}\r\n\r\nexport default new Loading();"]}