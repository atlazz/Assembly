{"version":3,"sources":["Reward.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"..\\..\\..\\..\\..\\assets\\scripts\\component","sourcesContent":["import wx from \"../SDK/wx\";\r\nimport ws from \"../SDK/ws\";\r\nimport * as Ad from \"./Ad\";\r\nimport Global from \"../Global\";\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nexport default class Reward extends cc.Component {\r\n    static instance: Reward;\r\n\r\n    private shareTimestampMap = {};\r\n    private lastShareTimestamp: number = 0;\r\n    private shareArgs: IArguments;\r\n\r\n    onLoad() {\r\n        !Reward.instance && (Reward.instance = this);\r\n\r\n        CC_WECHATGAME && wx.onShow((e) => {\r\n            let shareArgs = this.shareArgs;\r\n            if (shareArgs && shareArgs.length) {\r\n                let option = shareArgs[0] || {};\r\n                let pos = option.pos;\r\n                let success = option.success;\r\n                let fail = option.fail;\r\n                let complete = option.complete;\r\n                try {\r\n                    let now = Date.now();\r\n                    if (success || fail) {\r\n                        if (Global.config.share_delay <= 0.1 || (now - this.lastShareTimestamp) > ((Global.config.share_delay || 5) * 1000)) {\r\n                            Global.gameData.shareCount++;\r\n                            Global.gameData.lastShareTimestamp = now;\r\n                            this.shareTimestampMap[pos] = now;\r\n                            success && success(e);\r\n                            complete && complete(e);\r\n                        } else {\r\n                            this.shareTimestampMap[pos] = 0;\r\n                            wx.showModal({\r\n                                title: '提示',\r\n                                content: Global.config.share_fail,\r\n                                cancelText: '知道了',\r\n                                confirmText: '重新发送',\r\n                                success: (res) => {\r\n                                    if (res.confirm) {\r\n                                        this.share.apply(this, shareArgs);\r\n                                    } else {\r\n                                        fail && fail(e);\r\n                                        complete && complete(e);\r\n                                    }\r\n                                }\r\n                            });\r\n                        }\r\n                    } else {\r\n                        this.shareTimestampMap[pos] = 0;\r\n                        complete && complete(e);\r\n                    }\r\n                } finally {\r\n                    this.lastShareTimestamp = 0;\r\n                    this.shareArgs = null;\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    reward({ pos, query, success, fail, complete }: { pos: string, query?: string, success?: Function, fail?: Function, complete?: Function }) {\r\n        if (this.isShareState(pos)) {\r\n            this.share({ pos, query, success, fail, complete });\r\n        } else {\r\n            this.video({ pos, success, fail, complete });\r\n        }\r\n    }\r\n\r\n    share({ pos, query, success, fail, complete }: { pos: string, query?: string, success?: Function, fail?: Function, complete?: Function }) {\r\n        if (!CC_WECHATGAME) {\r\n            console.log('onMiniGame = false');\r\n            fail && fail();\r\n            complete && complete();\r\n            return;\r\n        }\r\n\r\n        if (!this.isOnline() || !this.allowShare(pos)) {\r\n            console.log('share not allowed');\r\n            fail && fail();\r\n            complete && complete();\r\n            return;\r\n        }\r\n\r\n        let now = Date.now();\r\n        let shareTimestamp = Number(this.shareTimestampMap[pos]);\r\n        if (shareTimestamp && (now - shareTimestamp < Global.config.share_time * 1000)) {\r\n            console.log('请稍等一会再操作');\r\n            fail && fail();\r\n            complete && complete();\r\n            return;\r\n        }\r\n        if (success || fail) {\r\n            this.shareTimestampMap[pos] = now;\r\n        }\r\n        this.lastShareTimestamp = Date.now();\r\n        this.shareArgs = arguments;\r\n        ws.share({ pos, query });\r\n    }\r\n\r\n    video({ pos, success, fail, complete }: { pos: string, success?: Function, fail?: Function, complete?: Function }) {\r\n        if (!CC_WECHATGAME) {\r\n            console.log('onMiniGame = false');\r\n            fail && fail();\r\n            complete && complete();\r\n            return;\r\n        }\r\n\r\n        Ad.posShowVideo(pos, /**onErrorCallback*/() => {\r\n            console.log('今日视频已看完');\r\n            fail && fail();\r\n            complete && complete();\r\n        }, /**onCloseCallback*/(res) => {\r\n            if ((res && res.isEnded) || res === undefined) {\r\n                Global.gameData.videoCount++;\r\n                Global.gameData.lastVideoTimestamp = Date.now();\r\n                success && success();\r\n            } else {\r\n                // 未看完关闭视频，不算视频获取播放失败\r\n                if (!(res && !res.isEnded)) {\r\n                    fail && fail();\r\n                }\r\n            }\r\n            complete && complete();\r\n        });\r\n    }\r\n\r\n    //允许转发\r\n    allowShare(pos?: string): boolean {\r\n        let flag = Global.config[pos + '_allow_share'];\r\n        if ('boolean' === typeof flag) {\r\n            return flag;\r\n        } else {\r\n            return Global.config.allow_share;\r\n        }\r\n    }\r\n\r\n    //允许视频\r\n    allowVideo(pos?: string): boolean {\r\n        let flag = Global.config[pos + '_allow_video'];\r\n        if ('boolean' === typeof flag) {\r\n            return flag;\r\n        } else {\r\n            return Global.config.allow_video;\r\n        }\r\n    }\r\n\r\n    //是否线上版本\r\n    isOnline(): boolean {\r\n        return Global.config.online;\r\n    }\r\n\r\n    //分享优先\r\n    isShareFirst(pos?: string): boolean {\r\n        let flag = Global.config[pos + '_share_first'];\r\n        if ('boolean' === typeof flag) {\r\n            return flag;\r\n        } else {\r\n            return Global.config.share_first;\r\n        }\r\n    }\r\n\r\n    //分享次数\r\n    getShareCount(): number {\r\n        let now = new Date();\r\n        let todayBeginTimestamp = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();\r\n        if (!Global.gameData.lastShareTimestamp || Global.gameData.lastShareTimestamp < todayBeginTimestamp) {\r\n            Global.gameData.shareCount = 0;\r\n        }\r\n        return Global.gameData.shareCount;\r\n    }\r\n\r\n    //分享超过次数\r\n    isOverShare(): boolean {\r\n        return Global.config.share_number && Global.config.share_number <= this.getShareCount();\r\n    }\r\n\r\n    //视频次数\r\n    getVideoCount(): number {\r\n        let now = new Date();\r\n        let todayBeginTimestamp = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();\r\n        if (!Global.gameData.lastVideoTimestamp || Global.gameData.lastVideoTimestamp < todayBeginTimestamp) {\r\n            Global.gameData.videoCount = 0;\r\n        }\r\n        return Global.gameData.videoCount;\r\n    }\r\n\r\n    //视频超过次数\r\n    isOverVideo(): boolean {\r\n        return Global.config.video_number && Global.config.video_number <= this.getVideoCount();\r\n    }\r\n\r\n    //是否有视频可观看\r\n    hasVideo(): boolean {\r\n        return Ad.hasVideoAd();\r\n    }\r\n\r\n    isShareState(pos?: string): boolean {\r\n        if (!this.isOnline() || !this.allowShare(pos)) {\r\n            return false;\r\n        } else if (this.allowVideo(pos) && this.hasVideo()) {\r\n            if (this.isShareFirst(pos)) {\r\n                if (this.isOverShare()) {\r\n                    return this.isOverVideo();\r\n                } else {\r\n                    return true;\r\n                }\r\n            } else {\r\n                return this.isOverVideo();\r\n            }\r\n        } else {\r\n            return true;\r\n        }\r\n    }\r\n\r\n}"]}